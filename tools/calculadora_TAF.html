<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TAF BA | Bombeiros de Aeródromo</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@500;700&family=Orbitron:wght@500;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --green-ok: #4caf50;
            --yellow-warn: #ff9800;
            --red-hot: #f44336;
        }

        :root[data-theme="dark"] {
            --bg: #000000;
            --panel: #141414;
            --primary: rgb(20, 20, 20);
            --text: #eaeaea;
            --text-dim: #888888;
            --steel: #333333;
            --btn-trig-bg: #000;
            --modal-bg-rgb: 0, 0, 0;
            --input-bg: #000;
            --result-bg: rgba(0, 0, 0, 0.5);
            --panel-sh: rgba(0, 0, 0, 0.9);
        }

        :root[data-theme="light"] {
            --bg: #f0f2f5;
            --panel: #ffffff;
            --primary: #f8f9fa;
            --text: #1a1a1a;
            --text-dim: #666666;
            --steel: #e0e0e0;
            --btn-trig-bg: #f8f9fa;
            --modal-bg-rgb: 255, 255, 255;
            --input-bg: #f8f9fa;
            --result-bg: #f8f9fa;
            --panel-sh: rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .cmd-bar {
            background: var(--panel);
            padding: calc(15px + env(safe-area-inset-top)) 15px 15px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--steel);
            flex-shrink: 0;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .sys-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sys-title svg {
            fill: var(--text);
            transition: fill 0.3s;
        }

        .sys-name {
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            font-weight: 900;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text);
            transition: color 0.3s;
        }

        .sys-sub {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 1px;
            transition: color 0.3s;
        }

        .btn-hist {
            background: transparent;
            border: 1px solid var(--steel);
            color: var(--text-dim);
            padding: 6px 12px;
            border-radius: 4px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .btn-hist:active {
            background: var(--steel);
            color: var(--text);
        }

        .btn-theme {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--steel);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            transition: all 0.2s;
        }

        .btn-theme:active {
            background: var(--steel);
        }

        .btn-theme svg {
            fill: currentColor;
        }

        .bar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .mission-strip {
            background: var(--panel);
            border-bottom: 1px solid var(--steel);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .strip-bg {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: rgba(128, 128, 128, 0.4);
            z-index: 1;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .strip-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            z-index: 1;
            transition: width 0.3s linear, background-color 0.3s ease;
        }

        .strip-bar.ok {
            background: rgba(76, 175, 80, 0.2);
            border-right: 2px solid var(--green-ok);
        }

        .strip-bar.warn {
            background: rgba(255, 152, 0, 0.2);
            border-right: 2px solid var(--yellow-warn);
        }

        .strip-bar.fail {
            background: rgba(244, 67, 54, 0.2);
            border-right: 2px solid var(--red-hot);
        }

        .strip-info {
            position: relative;
            z-index: 2;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .strip-status {
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-dim);
            letter-spacing: 1px;
            transition: color 0.3s;
        }

        .strip-time {
            font-family: 'Share Tech Mono', monospace;
            font-size: 18px;
            font-weight: bold;
            color: var(--text);
            text-shadow: 0 0 10px rgba(128, 128, 128, 0.2);
            transition: color 0.3s;
        }

        .blink {
            animation: flash 1s infinite alternate;
        }

        @keyframes flash {
            from {
                opacity: 1;
            }

            to {
                opacity: 0.3;
            }
        }

        .critical-blink {
            animation: blinker 0.4s infinite alternate;
        }

        @keyframes blinker {
            from {
                opacity: 1;
            }

            to {
                opacity: 0.3;
            }
        }

        .main-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px 15px;
            gap: 10px;
            overflow-y: auto;
        }

        .input-group {
            background: var(--panel);
            padding: 10px 15px;
            border-radius: 6px;
            border-left: 3px solid var(--steel);
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-group label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            transition: color 0.3s;
        }

        select {
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--steel);
            padding: 8px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            border-radius: 4px;
            outline: none;
            appearance: none;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .ex-card {
            background: var(--panel);
            border: 1px solid var(--steel);
            border-radius: 8px;
            padding: 12px 15px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .ex-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--steel);
            transition: background 0.3s;
        }

        .ex-card.active {
            border-color: var(--text-dim);
            background: var(--bg);
            box-shadow: 0 4px 15px var(--panel-sh);
        }

        .ex-card.active::before {
            background: var(--text);
            box-shadow: 0 0 10px var(--text);
        }

        .ex-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .ex-title {
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            font-weight: 900;
            color: var(--text-dim);
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: color 0.3s;
        }

        .ex-target {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            background: var(--input-bg);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text-dim);
            border: 1px solid var(--steel);
            transition: all 0.3s;
        }

        .ex-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-val {
            font-family: 'Share Tech Mono', monospace;
            font-size: 38px;
            color: var(--text-dim);
            font-weight: bold;
            line-height: 1;
            transition: color 0.3s;
        }

        .ex-card.active .timer-val {
            color: var(--text);
            text-shadow: 0 0 12px rgba(128, 128, 128, 0.2);
            animation: pulseTimer 2s infinite;
        }

        @keyframes pulseTimer {
            0% {
                text-shadow: 0 0 10px rgba(128, 128, 128, 0.1);
            }

            50% {
                text-shadow: 0 0 20px rgba(128, 128, 128, 0.3);
            }

            100% {
                text-shadow: 0 0 10px rgba(128, 128, 128, 0.1);
            }
        }

        .btn-trigger {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            border: 1px solid var(--steel);
            background: var(--btn-trig-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-trigger svg {
            fill: var(--text-dim);
            margin-bottom: 2px;
            transition: fill 0.3s;
        }

        .trig-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-dim);
            transition: color 0.3s;
        }

        .btn-trigger.running {
            background: var(--text);
            border-color: var(--text);
            box-shadow: 0 0 15px rgba(128, 128, 128, 0.2);
        }

        .btn-trigger.running svg {
            fill: var(--bg);
        }

        .btn-trigger.running .trig-label {
            color: var(--bg);
        }

        .btn-end {
            background: var(--red-hot);
            color: #fff;
            border: none;
            padding: 18px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-radius: 6px;
            margin-top: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 0 #b71c1c;
            margin-bottom: env(safe-area-inset-bottom);
        }

        .btn-end:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #b71c1c;
        }

        #overlay {
            position: fixed;
            inset: 0;
            background: rgba(var(--modal-bg-rgb), 0.85);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }

        .modal-panel {
            width: 100%;
            max-width: 400px;
            background: var(--panel);
            border-radius: 8px;
            padding: 28px;
            position: relative;
            display: none;
            box-shadow: 0 20px 50px var(--panel-sh);
            text-align: center;
            border: 1px solid var(--steel);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .modal-title {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 900;
            color: var(--text);
            letter-spacing: 2px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--steel);
            text-transform: uppercase;
            transition: color 0.3s, border-color 0.3s;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
            text-align: left;
        }

        .step-num {
            font-family: 'Share Tech Mono', monospace;
            background: var(--steel);
            color: var(--text);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
            margin-top: 2px;
            transition: background-color 0.3s, color 0.3s;
        }

        .step-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            color: var(--text-dim);
            line-height: 1.4;
            transition: color 0.3s;
        }

        .step-text strong {
            color: var(--text);
            display: block;
            font-size: 15px;
            margin-bottom: 2px;
            transition: color 0.3s;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--steel);
            background: var(--primary);
            color: var(--text);
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s, color 0.3s;
        }

        .btn-primary:active {
            background: var(--steel);
        }

        .btn-danger {
            width: 100%;
            padding: 16px;
            border: none;
            background: var(--red-hot);
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 0 #b71c1c;
            margin-top: 10px;
        }

        .btn-ghost {
            width: 100%;
            padding: 14px;
            border: 1.5px solid var(--steel);
            background: transparent;
            color: var(--text-dim);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s;
        }

        .btn-ghost:active {
            background: var(--steel);
            color: var(--text);
        }

        .loader-wrap {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            color: var(--text);
        }

        .loader-ring {
            width: 40px;
            height: 40px;
            border: 3px solid var(--steel);
            border-top-color: var(--text);
            border-radius: 50%;
            animation: rot 1s linear infinite;
        }

        @keyframes rot {
            to {
                transform: rotate(360deg);
            }
        }

        .result-rows {
            margin-top: 20px;
            text-align: left;
            background: var(--result-bg);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--steel);
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--steel);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .rr-label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            transition: color 0.3s;
        }

        .rr-val {
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            font-size: 14px;
            color: var(--text);
            transition: color 0.3s;
        }

        .result-total {
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--steel);
        }

        .result-total .rr-val {
            font-size: 20px;
            color: var(--text);
            font-family: 'Share Tech Mono', monospace;
            font-weight: bold;
        }

        .nota-detail {
            font-size: 12px;
            font-family: 'Share Tech Mono', monospace;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .nota-detail.positivo {
            color: var(--green-ok);
        }

        .nota-detail.negativo {
            color: var(--red-hot);
        }

        .btn-export {
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--steel);
            padding: 14px;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            font-weight: 700;
            border-radius: 6px;
            text-transform: uppercase;
            font-family: 'Rajdhani', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
            font-size: 14px;
            letter-spacing: 1px;
        }

        #toast {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--input-bg);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 6px;
            display: none;
            z-index: 1000;
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            border: 1px solid var(--steel);
            box-shadow: 0 4px 15px var(--panel-sh);
            font-size: 14px;
            letter-spacing: 1px;
            white-space: nowrap;
            transition: all 0.3s;
        }
    </style>
    <script>
        const savedTheme = localStorage.getItem('theme_preference_bataf') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    </script>
</head>

<body>

    <div class="cmd-bar">
        <div class="sys-title">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path
                    d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,3L19,6.11V11C19,15.33 16.25,19.43 12,20.93C7.75,19.43 5,15.33 5,11V6.11L12,3Z" />
            </svg>
            <div>
                <div class="sys-name">TAF BA</div>
                <div class="sys-sub">MOD. FISIOLÓGICO</div>
            </div>
        </div>
        <div class="bar-actions">
            <button class="btn-theme" onclick="toggleTheme()" title="Alternar Tema">
                <svg id="theme-icon-light" style="display:none;" viewBox="0 0 24 24" width="16" height="16">
                    <path
                        d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,6.65C6.9,7.16 6.36,7.78 5.94,8.5C5.5,9.24 5.25,10 5.11,10.79L3.34,7M3.36,17L5.12,13.23C5.26,14 5.53,14.78 5.95,15.5C6.37,16.24 6.91,16.86 7.5,17.37L3.36,17M20.65,7L18.88,10.79C18.74,10 18.47,9.23 18.05,8.5C17.63,7.76 17.09,7.14 16.5,6.63L20.65,7M20.64,17L16.5,17.36C17.09,16.85 17.62,16.22 18.04,15.5C18.46,14.77 18.73,14 18.87,13.21L20.64,17M12,22L9.59,18.56C10.33,18.83 11.14,19 12,19C12.86,19 13.67,18.83 14.41,18.56L12,22Z" />
                </svg>
                <svg id="theme-icon-dark" style="display:none;" viewBox="0 0 24 24" width="16" height="16">
                    <path
                        d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.11,19.05C17.14,21 14.23,21.84 11.45,21.14C8.67,20.44 6.31,18.3 5.37,15.58C4.43,12.85 4.96,9.82 6.78,7.56C7.26,6.96 7.78,6.46 8.35,6C9.07,5.43 10.37,6.4 9.9,7.25C9.42,8.08 9.17,9.03 9.17,10C9.17,13.22 11.78,15.83 15,15.83C16.32,15.83 17.55,15.39 18.55,14.65C18.69,14.55 18.82,14.44 18.97,14.33C18.97,14.88 18.97,15.42 18.97,15.95Z" />
                </svg>
            </button>
            <button class="btn-hist" onclick="history.back()">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                    <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
                </svg>
                VOLTAR
            </button>
        </div>
    </div>

    <!-- Barra de Missão -->
    <div class="mission-strip">
        <div class="strip-bar" id="progressBar"></div>
        <div class="strip-info">
            <span class="strip-status" id="notaAtual">NOTA: -</span>
            <span class="strip-time" id="regressivo">00:00,00</span>
        </div>
    </div>

    <div class="main-stage">
        <div class="input-group">
            <label for="idade">Idade do Bombeiro</label>
            <select id="idade"></select>
        </div>

        <div class="ex-card" id="card-flexao">
            <div class="ex-header">
                <span class="ex-title">Flexões</span>
                <span class="ex-target">30 REP</span>
            </div>
            <div class="ex-row">
                <div class="timer-val" id="flexaoTime">00:00,00</div>
                <button class="btn-trigger" id="btn-flexao" onclick="ativar('flexao')">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                    </svg>
                    <span class="trig-label">INICIAR</span>
                </button>
            </div>
        </div>

        <div class="ex-card" id="card-abdominal">
            <div class="ex-header">
                <span class="ex-title">Abdominais</span>
                <span class="ex-target">45 REP</span>
            </div>
            <div class="ex-row">
                <div class="timer-val" id="abdominalTime">00:00,00</div>
                <button class="btn-trigger" id="btn-abdominal" onclick="ativar('abdominal')">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                    </svg>
                    <span class="trig-label">INICIAR</span>
                </button>
            </div>
        </div>

        <div class="ex-card" id="card-polichinelo">
            <div class="ex-header">
                <span class="ex-title">Polichinelos</span>
                <span class="ex-target">45 REP</span>
            </div>
            <div class="ex-row">
                <div class="timer-val" id="polichineloTime">00:00,00</div>
                <button class="btn-trigger" id="btn-polichinelo" onclick="ativar('polichinelo')">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                    </svg>
                    <span class="trig-label">INICIAR</span>
                </button>
            </div>
        </div>

        <button class="btn-end" onclick="confirmarEncerramento()">ENCERRAR MISSÃO</button>
    </div>

    <!-- Overlay unificado -->
    <div id="overlay">
        <div class="modal-panel" id="introModal">
            <div class="modal-title">Guia de Operação</div>
            <div class="instruction-item">
                <div class="step-num">1</div>
                <div class="step-text"><strong>Configuração</strong>Selecione a idade do Bombeiro para carregar os
                    critérios da avaliação.</div>
            </div>
            <div class="instruction-item">
                <div class="step-num">2</div>
                <div class="step-text"><strong>Início</strong>Toque no Play em qualquer teste para começar. O tempo é
                    contínuo e compartilhado.</div>
            </div>
            <div class="instruction-item">
                <div class="step-num">3</div>
                <div class="step-text"><strong>Migração</strong>Toque no Play de outro teste para transferir a
                    cronometragem. Você pode alternar livremente.</div>
            </div>
            <div class="instruction-item">
                <div class="step-num">4</div>
                <div class="step-text"><strong>Conclusão</strong>O cronômetro só para definitivamente ao clicar em
                    "Encerrar Missão".</div>
            </div>
            <button class="btn-primary" onclick="fecharIntro()">Iniciar Operação</button>
        </div>

        <!-- Modal de confirmação de encerramento -->
        <div class="modal-panel" id="confirmModal">
            <div class="modal-title" style="color:var(--red-hot);border-color:var(--steel);">ENCERRAR MISSÃO?</div>
            <p
                style="color:var(--text-dim);font-size:13px;font-family:'Share Tech Mono',monospace;margin-bottom:20px;line-height:1.5;">
                O cronômetro será parado<br>e o resultado calculado.</p>
            <button class="btn-danger" onclick="confirmarSim()" style="box-shadow:none;">Confirmar Encerramento</button>
            <button class="btn-ghost" onclick="confirmarNao()">Voltar ao TAF</button>
        </div>

        <div class="loader-wrap" id="loader">
            <div class="loader-ring"></div>
            <div style="font-family:'Share Tech Mono',monospace;font-weight:bold;">PROCESSANDO DADOS...</div>
        </div>

        <div class="modal-panel" id="finalModal">
            <div class="modal-title">RELATÓRIO TAF</div>
            <div id="results-content"></div>
            <button class="btn-export" style="background:var(--primary);border:none;" onclick="exportarImagem()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" />
                </svg>
                SALVAR COMO IMAGEM
            </button>
            <button class="btn-ghost" onclick="fecharModalCompleto()">NOVO TAF</button>
        </div>
    </div>

    <div id="toast"></div>

    <!-- Canvas oculto para exportação -->
    <canvas id="exportCanvas" style="display:none;"></canvas>

    <script>
        // ─── Tema ─────────────────────────────────────────────────────────────────
        function toggleTheme() {
            const root = document.documentElement;
            const newTheme = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            root.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme_preference_bataf', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const theme = document.documentElement.getAttribute('data-theme');
            document.getElementById('theme-icon-light').style.display = theme === 'dark' ? 'block' : 'none';
            document.getElementById('theme-icon-dark').style.display = theme === 'light' ? 'block' : 'none';
        }

        // ─── Estado da aplicação ───────────────────────────────────────────────────
        const EXERCISES = ['flexao', 'abdominal', 'polichinelo'];

        const state = {
            activeExercise: null,
            rafId: null,
            startTimestamp: 0,
            timers: { flexao: 0, abdominal: 0, polichinelo: 0 },
            finalData: null,
        };

        function getLimites(idade) {
            if (!idade) return null;
            return Number(idade) < 40
                ? { 10: 120000, 9: 140000, 8: 160000, 7: 180000 }
                : { 10: 180000, 9: 200000, 8: 220000, 7: 240000 };
        }

        function formatTime(ms) {
            const absMs = Math.abs(ms);
            const mins = Math.floor(absMs / 60000);
            const secs = Math.floor((absMs % 60000) / 1000);
            const cents = Math.floor((absMs % 1000) / 10);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')},${String(cents).padStart(2, '0')}`;
        }

        function calcularNota(total, limites) {
            if (!limites) return { nota: '-', colorClass: '' };
            if (total <= limites[10]) return { nota: '10', colorClass: 'ok' };
            if (total <= limites[9]) return { nota: '9', colorClass: 'warn' };
            if (total <= limites[8]) return { nota: '8', colorClass: 'warn' };
            if (total <= limites[7]) return { nota: '7', colorClass: 'fail' };
            return { nota: 'REPROVADO', colorClass: 'fail' };
        }

        function popularSelectIdade() {
            const sel = document.getElementById('idade');
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'ESCOLHA A IDADE';
            placeholder.disabled = true;
            placeholder.selected = true;
            sel.appendChild(placeholder);

            for (let i = 18; i <= 65; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `${i} ANOS`;
                sel.appendChild(opt);
            }

            sel.addEventListener('change', resetarContagem);
        }

        function showToast(msg, duration = 3000) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            clearTimeout(t._timeout);
            t._timeout = setTimeout(() => { t.style.display = 'none'; }, duration);
        }

        function resetarContagem() {
            const idadeVal = document.getElementById('idade').value;
            if (!idadeVal) return;
            const limites = getLimites(Number(idadeVal));
            document.getElementById('regressivo').innerText = formatTime(limites[7]);
            document.getElementById('notaAtual').innerText = 'NOTA: 10';
            document.getElementById('notaAtual').style.color = 'var(--text-dim)';
            const bar = document.getElementById('progressBar');
            bar.className = 'strip-bar ok';
            bar.style.width = '0%';
        }

        function updateTimeline() {
            const idadeVal = document.getElementById('idade').value;
            if (!idadeVal) return;

            const limites = getLimites(Number(idadeVal));
            const total = state.timers.flexao + state.timers.abdominal + state.timers.polichinelo;
            const { nota, colorClass } = calcularNota(total, limites);

            const bar = document.getElementById('progressBar');
            const notaTxt = document.getElementById('notaAtual');
            const reg = document.getElementById('regressivo');

            bar.className = 'strip-bar ' + colorClass;
            bar.style.width = Math.min((total / limites[7]) * 100, 100) + '%';
            notaTxt.innerText = 'NOTA: ' + nota;

            if (colorClass === 'ok') notaTxt.style.color = 'var(--green-ok)';
            else if (colorClass === 'warn') notaTxt.style.color = 'var(--yellow-warn)';
            else notaTxt.style.color = 'var(--red-hot)';

            reg.innerText = formatTime(Math.max(0, limites[7] - total));

            if (nota === 'REPROVADO') {
                reg.classList.add('critical-blink');
                bar.classList.add('critical-blink');
            } else {
                reg.classList.remove('critical-blink');
                bar.classList.remove('critical-blink');
            }
        }

        function rafLoop(timestamp) {
            const ex = state.activeExercise;
            if (!ex) return;

            state.timers[ex] = Date.now() - state.startTimestamp;
            document.getElementById(ex + 'Time').innerText = formatTime(state.timers[ex]);
            updateTimeline();

            state.rafId = requestAnimationFrame(rafLoop);
        }

        function ativar(exercise) {
            const idade = document.getElementById('idade').value;
            if (!idade) { showToast('⚠️ SELECIONE A IDADE!'); return; }
            if (state.activeExercise === exercise) return;

            if (state.rafId) cancelAnimationFrame(state.rafId);

            state.activeExercise = exercise;
            state.startTimestamp = Date.now() - state.timers[exercise];

            state.rafId = requestAnimationFrame(rafLoop);
            updateUI();
        }

        function updateUI() {
            EXERCISES.forEach(ex => {
                const card = document.getElementById('card-' + ex);
                const btn = document.getElementById('btn-' + ex);
                const isActive = state.activeExercise === ex;

                card.classList.toggle('active', isActive);
                btn.classList.toggle('running', isActive);
                btn.innerHTML = isActive
                    ? `<svg viewBox="0 0 24 24" width="24" height="24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg><span class="trig-label">ATIVO</span>`
                    : `<svg viewBox="0 0 24 24" width="24" height="24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg><span class="trig-label">INICIAR</span>`;
            });
        }

        function confirmarEncerramento() {
            const idade = document.getElementById('idade').value;
            if (!idade) { showToast('⚠️ SELECIONE A IDADE!'); return; }

            if (state.rafId) cancelAnimationFrame(state.rafId);

            const overlay = document.getElementById('overlay');
            overlay.style.display = 'flex';
            document.getElementById('confirmModal').style.display = 'block';
            document.getElementById('introModal').style.display = 'none';
            document.getElementById('loader').style.display = 'none';
            document.getElementById('finalModal').style.display = 'none';
        }

        function confirmarSim() {
            document.getElementById('confirmModal').style.display = 'none';
            finalizar();
        }

        function confirmarNao() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'none';

            if (state.activeExercise) {
                state.startTimestamp = Date.now() - state.timers[state.activeExercise];
                state.rafId = requestAnimationFrame(rafLoop);
            }
        }

        function finalizar() {
            if (state.rafId) cancelAnimationFrame(state.rafId);
            state.activeExercise = null;
            updateUI();

            const idadeVal = document.getElementById('idade').value;
            if (!idadeVal) { showToast('⚠️ SELECIONE A IDADE!'); return; }

            const limites = getLimites(Number(idadeVal));
            const total = state.timers.flexao + state.timers.abdominal + state.timers.polichinelo;
            const { nota } = calcularNota(total, limites);

            const notaNum = parseInt(nota);
            let detalhe = '';
            if (!isNaN(notaNum)) {
                if (notaNum < 10) {
                    const faltou = total - limites[notaNum + 1];
                    detalhe = `<div class="nota-detail negativo">▲ ${formatTime(faltou)} além do limite da nota ${notaNum + 1}</div>`;
                } else {
                    detalhe = `<div class="nota-detail positivo">✔ Nota máxima atingida</div>`;
                }
            } else {
                const faltou = total - limites[7];
                detalhe = `<div class="nota-detail negativo">▲ ${formatTime(faltou)} além do limite de aprovação</div>`;
            }

            state.finalData = {
                idade: idadeVal,
                timers: { ...state.timers },
                total,
                nota,
                detalhe,
                limites,
            };

            const bg = nota === 'REPROVADO' ? 'rgba(244, 67, 54, 0.1)' : (nota === '10' ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 152, 0, 0.1)');
            const color = nota === 'REPROVADO' ? 'var(--red-hot)' : (nota === '10' ? 'var(--green-ok)' : 'var(--yellow-warn)');

            document.getElementById('results-content').innerHTML = `
            <div style="background:${bg}; border:1px solid ${color}; color:${color}; text-align:center; padding:12px; border-radius:6px; margin-bottom:15px;">
                <span style="font-family:Orbitron; font-size:24px; font-weight:900;">NOTA: ${nota}</span>
            </div>
            <div class="result-rows">
                <div class="result-row"><span class="rr-label">FLEXÕES:</span><span class="rr-val">${formatTime(state.timers.flexao)}</span></div>
                <div class="result-row"><span class="rr-label">ABDOMINAIS:</span><span class="rr-val">${formatTime(state.timers.abdominal)}</span></div>
                <div class="result-row"><span class="rr-label">POLICHINELOS:</span><span class="rr-val">${formatTime(state.timers.polichinelo)}</span></div>
                <div class="result-row result-total"><span class="rr-label">TEMPO TOTAL:</span><span class="rr-val">${formatTime(total)}</span></div>
            </div>
            ${detalhe}
        `;

            const overlay = document.getElementById('overlay');
            overlay.style.display = 'flex';
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('finalModal').style.display = 'none';
            document.getElementById('introModal').style.display = 'none';

            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('finalModal').style.display = 'block';
            }, 1200);
        }

        function exportarImagem() {
            const d = state.finalData;
            if (!d) return;

            const W = 640, H = 560;
            const canvas = document.getElementById('exportCanvas');
            canvas.width = W;
            canvas.height = H;
            const ctx = canvas.getContext('2d');

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

            const bgColor = isDark ? '#000000' : '#f0f2f5';
            const panelColor = isDark ? '#141414' : '#ffffff';
            const textColor = isDark ? '#ffffff' : '#1a1a1a';
            const textDim = isDark ? '#888888' : '#666666';
            const strokeColor = isDark ? '#333333' : '#e0e0e0';

            const bg = ctx.createLinearGradient(0, 0, 0, H);
            bg.addColorStop(0, panelColor);
            bg.addColorStop(1, bgColor);
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, W, H);

            ctx.fillStyle = isDark ? '#1a1a1a' : '#ffffff';
            ctx.fillRect(0, 0, W, 70);

            ctx.fillStyle = strokeColor;
            ctx.fillRect(0, 70, W, 2);

            ctx.fillStyle = textColor;
            ctx.font = 'bold 26px Oswald, Rajdhani, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('TAF - BA  |  MOD. FISIOLÓGICO', W / 2, 46);

            ctx.font = '16px Oswald, Rajdhani, sans-serif';
            ctx.fillStyle = textDim;
            ctx.fillText(`Bombeiro · ${d.idade} Anos`, W / 2, 66);

            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 1;

            const exercicios = [
                { label: 'FLEXÕES', time: d.timers.flexao },
                { label: 'ABDOMINAIS', time: d.timers.abdominal },
                { label: 'POLICHINELOS', time: d.timers.polichinelo },
            ];

            let y = 115;
            ctx.textAlign = 'left';

            exercicios.forEach((ex) => {
                ctx.fillStyle = isDark ? '#1e1e1e' : '#f8f9fa';
                roundRect(ctx, 40, y, W - 80, 62, 8);
                ctx.fill();

                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = 1;
                roundRect(ctx, 40, y, W - 80, 62, 8);
                ctx.stroke();

                ctx.fillStyle = textDim;
                ctx.font = '13px "Share Tech Mono", monospace';
                ctx.fillText(ex.label, 60, y + 22);

                ctx.fillStyle = textColor;
                ctx.font = 'bold 28px "Share Tech Mono", monospace';
                ctx.fillText(formatTime(ex.time), 60, y + 50);

                y += 78;
            });

            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(40, y);
            ctx.lineTo(W - 40, y);
            ctx.stroke();
            y += 18;

            ctx.textAlign = 'left';
            ctx.fillStyle = textDim;
            ctx.font = '14px "Share Tech Mono", monospace';
            ctx.fillText('TEMPO TOTAL', 40, y + 16);

            ctx.fillStyle = textColor;
            ctx.font = 'bold 22px "Share Tech Mono", monospace';
            ctx.textAlign = 'right';
            ctx.fillText(formatTime(d.total), W - 40, y + 16);
            y += 50;

            const notaNum = parseInt(d.nota);
            let notaColor = '#f44336';
            if (d.nota === '10') notaColor = '#4caf50';
            else if (d.nota === '9') notaColor = '#ffb300';
            else if (d.nota === '8') notaColor = '#ff9800';
            else if (d.nota === '7') notaColor = '#ff5722';

            ctx.fillStyle = notaColor;
            roundRect(ctx, 40, y, W - 80, 80, 10);
            ctx.fill();

            ctx.fillStyle = isDark ? '#111111' : '#ffffff';
            ctx.font = 'bold 42px Orbitron, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`NOTA: ${d.nota}`, W / 2, y + 56);

            y += 96;

            const detalheTexto = gerarDetalheTexto(d);
            ctx.font = '14px "Share Tech Mono", monospace';
            ctx.fillStyle = notaColor === '#4caf50' ? '#4caf50' : '#f44336';
            ctx.textAlign = 'center';
            ctx.fillText(detalheTexto, W / 2, y);

            ctx.fillStyle = textDim;
            ctx.font = '12px "Share Tech Mono", monospace';
            ctx.textAlign = 'center';
            ctx.fillText(`Gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`, W / 2, H - 18);

            const link = document.createElement('a');
            link.download = `TAF-BA_Nota${d.nota}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function gerarDetalheTexto(d) {
            const notaNum = parseInt(d.nota);
            if (!isNaN(notaNum)) {
                if (notaNum < 10) {
                    const faltou = d.total - d.limites[notaNum + 1];
                    return `${formatTime(faltou)} além do limite da nota ${notaNum + 1}`;
                }
                return '✔ Nota máxima atingida';
            }
            const faltou = d.total - d.limites[7];
            return `${formatTime(faltou)} além do limite de aprovação`;
        }

        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        function fecharModalCompleto() {
            if (state.rafId) cancelAnimationFrame(state.rafId);

            state.activeExercise = null;
            state.rafId = null;
            state.timers = { flexao: 0, abdominal: 0, polichinelo: 0 };
            state.finalData = null;

            document.getElementById('idade').selectedIndex = 0;
            document.querySelectorAll('.timer-val').forEach(d => { d.innerText = '00:00,00'; });
            document.getElementById('regressivo').innerText = '00:00,00';
            document.getElementById('notaAtual').innerText = 'NOTA: -';
            document.getElementById('notaAtual').style.color = 'var(--text-dim)';

            const bar = document.getElementById('progressBar');
            bar.style.width = '0%';
            bar.className = 'strip-bar';

            document.getElementById('overlay').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('finalModal').style.display = 'none';
            updateUI();
        }

        function fecharIntro() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('introModal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateThemeIcon();
            popularSelectIdade();
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('introModal').style.display = 'block';
        });
    </script>
</body>

</html>